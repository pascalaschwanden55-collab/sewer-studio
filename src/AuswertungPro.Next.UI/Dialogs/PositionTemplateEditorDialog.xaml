<Window x:Class="AuswertungPro.Next.UI.Dialogs.PositionTemplateEditorDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Baukasten: Positions-Vorlagen verwalten" 
        Width="1000" Height="680"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Theme/ThemeLight.xaml" />
                <ResourceDictionary Source="/Theme/Controls.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="Baukasten: Positions-Vorlagen" 
                       FontSize="18" FontWeight="SemiBold" />
            <TextBlock Text="Erstellen Sie Vorlagen für Massnahmen mit wiederverwendbaren Positionen" 
                       Foreground="{StaticResource MutedBrush}" Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="250"/>
            </Grid.ColumnDefinitions>

            <!-- Left: Groups List -->
            <Border Grid.Column="0" Style="{StaticResource Card}">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                        <TextBlock Text="Massnahmen-Gruppen" FontWeight="SemiBold" FontSize="14"/>
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <Button Content="+ Gruppe" Command="{Binding AddGroupCommand}" 
                                    Padding="8,4" MinWidth="80" Margin="0,0,4,0"/>
                            <Button Content="✕ Löschen" Command="{Binding RemoveGroupCommand}" 
                                    Padding="8,4" MinWidth="80" Style="{StaticResource SecondaryButton}"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <ListBox x:Name="GroupsListBox" 
                             ItemsSource="{Binding Groups}"
                             SelectedItem="{Binding SelectedGroup}"
                             DisplayMemberPath="Name"
                             ItemContainerStyle="{StaticResource NavItemStyle}"/>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="1" Width="8" HorizontalAlignment="Stretch" Background="Transparent"/>

            <!-- Right: Positions for Selected Group -->
            <Border Grid.Column="2" Style="{StaticResource Card}">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                        <DockPanel>
                            <TextBlock Text="Positionen in: " FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding SelectedGroup.Name, UpdateSourceTrigger=PropertyChanged}" 
                                     FontWeight="SemiBold" FontSize="14" 
                                     BorderThickness="0" Background="Transparent"
                                     Margin="4,0,0,0" VerticalAlignment="Center"/>
                        </DockPanel>
                        
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <Button Content="+ Position" Command="{Binding AddPositionCommand}" 
                                    Padding="8,4" MinWidth="100" Margin="0,0,4,0"/>
                            <Button Content="✕ Entfernen" Command="{Binding RemovePositionCommand}" 
                                    Padding="8,4" MinWidth="100" Margin="0,0,4,0" Style="{StaticResource SecondaryButton}"/>
                            <Button Content="→ Wartebox" Command="{Binding MoveToStorageCommand}" 
                                    Padding="8,4" MinWidth="100" Margin="0,0,4,0" Style="{StaticResource SecondaryButton}"
                                    ToolTip="In Wartebox verschieben"/>
                            <Button Content="↑" Command="{Binding MoveUpCommand}" 
                                    Padding="8,4" Width="36" Margin="0,0,4,0" Style="{StaticResource SecondaryButton}"
                                    ToolTip="Nach oben"/>
                            <Button Content="↓" Command="{Binding MoveDownCommand}" 
                                    Padding="8,4" Width="36" Style="{StaticResource SecondaryButton}"
                                    ToolTip="Nach unten"/>
                        </StackPanel>
                    </StackPanel>

                    <DataGrid x:Name="PositionsDataGrid" 
                              ItemsSource="{Binding SelectedGroup.Positions}"
                              SelectedItem="{Binding SelectedPosition}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              SelectionMode="Single"
                              AllowDrop="True"
                              PreviewMouseLeftButtonDown="PositionsDataGrid_PreviewMouseLeftButtonDown"
                              MouseMove="PositionsDataGrid_MouseMove"
                              Drop="PositionsDataGrid_Drop"
                              DragOver="PositionsDataGrid_DragOver">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="Aktiv" Binding="{Binding Enabled, UpdateSourceTrigger=PropertyChanged}" Width="60"/>
                            <DataGridTextColumn Header="Bezeichnung" Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                            <DataGridTextColumn Header="Einheit" Binding="{Binding Unit, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                            <DataGridTextColumn Header="Menge" Binding="{Binding DefaultQty, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" Width="80"/>
                            <DataGridTextColumn Header="Preis/Kosten" Binding="{Binding Price, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" Width="120"/>
                                <DataGridTemplateColumn Header="" Width="40">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="✕" Foreground="Red" Background="Transparent" BorderThickness="0" FontWeight="Bold" FontSize="18"
                                                ToolTip="Position löschen"
                                                Padding="0"
                                                Width="32" Height="32"
                                                Click="DeletePosition_Click"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="3" Width="8" HorizontalAlignment="Stretch" Background="Transparent"/>

            <!-- Right: Wartebox / Aufbewahrungsbox -->
            <Border Grid.Column="4" Style="{StaticResource Card}">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                        <TextBlock Text="Wartebox" FontWeight="SemiBold" FontSize="14"/>
                        <TextBlock Text="Verwendete Positionen" Foreground="{StaticResource MutedBrush}" FontSize="11" Margin="0,2,0,0"/>
                        
                        <Button Content="← Zurückholen" Command="{Binding RestoreFromStorageCommand}" 
                                Padding="8,4" MinWidth="100" Margin="0,8,0,0"
                                ToolTip="Position aus Wartebox zurück zur Gruppe"/>
                    </StackPanel>

                    <ListBox x:Name="StorageListBox"
                             ItemsSource="{Binding StorageBox}"
                             SelectedItem="{Binding SelectedStoragePosition}"
                             DisplayMemberPath="Name"
                             SelectionMode="Single"
                             Margin="0,4,0,0"
                             AllowDrop="True"
                             PreviewMouseLeftButtonDown="StorageListBox_PreviewMouseLeftButtonDown"
                             MouseMove="StorageListBox_MouseMove"
                             Drop="StorageListBox_Drop"
                             DragOver="StorageListBox_DragOver"/>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Footer Buttons -->
        <DockPanel Grid.Row="2" Margin="0,12,0,0">
            <Button Content="Standard wiederherstellen" Command="{Binding ResetToDefaultCommand}" 
                    DockPanel.Dock="Left"
                    Padding="12,8" MinWidth="100" Style="{StaticResource SecondaryButton}"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Speichern" Command="{Binding SaveCommand}" 
                        IsDefault="True" Margin="0,0,8,0" Padding="20,8" MinWidth="120"
                        Style="{StaticResource PrimaryButton}"/>
                <Button Content="Abbrechen" Command="{Binding CancelCommand}" 
                        IsCancel="True" Padding="20,8" MinWidth="120"
                        Style="{StaticResource SecondaryButton}"/>
            </StackPanel>
        </DockPanel>
    </Grid>
</Window>