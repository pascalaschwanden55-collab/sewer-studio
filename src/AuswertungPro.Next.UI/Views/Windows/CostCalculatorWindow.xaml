<Window x:Class="AuswertungPro.Next.UI.Views.Windows.CostCalculatorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Kostenberechnung" Width="1400" Height="800"
        MinWidth="900" MinHeight="500"
        AllowDrop="True"
        PreviewDragOver="Window_PreviewDragOver"
        PreviewDrop="Window_PreviewDrop">
    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280" MinWidth="200"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*" MinWidth="400"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="300" MinWidth="180"/>
        </Grid.ColumnDefinitions>

        <!-- Left panel: Massnahmen -->
        <GroupBox Header="Massnahmen">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <ListBox x:Name="MeasuresList"
                         Grid.Row="0"
                         ItemsSource="{Binding Measures}"
                         SelectionMode="Extended"
                         DisplayMemberPath="DisplayName"
                         SelectionChanged="MeasuresList_SelectionChanged"
                         MouseDoubleClick="MeasuresList_MouseDoubleClick" />
                <StackPanel Grid.Row="1">
                    <Button Height="38" Margin="0,8,0,0"
                            Content="Massnahmen uebernehmen"
                            Command="{Binding ApplyMeasuresCommand}"/>
                    <Button Height="32" Margin="0,5,0,0"
                            Content="Positionen verwalten..."
                            Command="{Binding EditPositionTemplatesCommand}"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- Splitter left|center -->
        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                      Background="Transparent" Cursor="SizeWE"/>

        <!-- Center panel: Kostenberechnung -->
        <GroupBox Grid.Column="2" Header="{Binding Header}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding SelectedMeasures}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="0,0,0,12" Padding="8" BorderThickness="1" BorderBrush="{StaticResource BorderBrush}"
                                        Background="Transparent">
                                    <StackPanel>
                                        <DockPanel>
                                            <Button DockPanel.Dock="Right" Content="X" Width="28" Height="28"
                                                    Foreground="Red" FontWeight="Bold"
                                                    Style="{x:Null}"
                                                    Command="{Binding DataContext.RemoveMeasureCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Massnahme entfernen"
                                                    Margin="8,0,0,0"/>
                                            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="8,0,0,0">
                                                <Button Content="^" Width="28" Height="28"
                                                        Style="{x:Null}"
                                                        Command="{Binding DataContext.MoveMeasureUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Massnahme nach oben"/>
                                                <Button Content="v" Width="28" Height="28" Margin="6,0,0,0"
                                                        Style="{x:Null}"
                                                        Command="{Binding DataContext.MoveMeasureDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Massnahme nach unten"/>
                                            </StackPanel>
                                            <Button DockPanel.Dock="Right" Content="Vorlage speichern" Height="28"
                                                    Padding="8,2" Margin="8,0,0,0"
                                                    Command="{Binding DataContext.SaveTemplateCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Speichert die aktuelle Positionen-Vorlage dauerhaft"/>
                                            <TextBlock Text="{Binding MeasureName}" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        </DockPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,6,0,8">
                                            <TextBlock Text="DN:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                            <TextBox Width="100" Text="{Binding DnText, UpdateSourceTrigger=PropertyChanged}" />
                                            <TextBlock Text="Linerlaenge (m):" VerticalAlignment="Center" Margin="14,0,6,0"/>
                                            <TextBox Width="120" Text="{Binding LengthText, UpdateSourceTrigger=PropertyChanged}" />
                                            <TextBlock Text="Anschluesse (Stk):" VerticalAlignment="Center" Margin="14,0,6,0"/>
                                            <TextBox Width="90" Text="{Binding ConnectionsText, UpdateSourceTrigger=PropertyChanged}" />
                                            <TextBlock Text="{Binding PriceHint}" Foreground="{StaticResource NeonPinkBrush}" Margin="12,0,0,0" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <DataGrid ItemsSource="{Binding Lines}" AutoGenerateColumns="False" CanUserAddRows="False"
                                                  ToolTip="Rechtsklick markiert Position fuer den Uebertrag (gruene Markierung)."
                                                  PreviewMouseRightButtonDown="LinesGrid_PreviewMouseRightButtonDown">
                                            <DataGrid.RowStyle>
                                                <Style TargetType="{x:Type DataGridRow}" BasedOn="{StaticResource {x:Type DataGridRow}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding TransferMarked}" Value="True">
                                                            <Setter Property="Background" Value="#D7F5DD"/>
                                                            <Setter Property="Foreground" Value="#0F3D1F"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.RowStyle>
                                            <DataGrid.Columns>
                                                <DataGridCheckBoxColumn Header="%" Binding="{Binding Selected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="40"/>
                                                <DataGridTextColumn Header="Gruppe" Binding="{Binding Group}" IsReadOnly="True" Width="130"/>
                                                <DataGridTextColumn Header="Position" Binding="{Binding Text}" IsReadOnly="True" Width="*"/>
                                                <DataGridTextColumn Header="Einheit" Binding="{Binding Unit}" IsReadOnly="True" Width="60"/>
                                                <DataGridTextColumn Header="Menge" Binding="{Binding Qty, Mode=TwoWay, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}" Width="75"/>
                                                <DataGridTextColumn Header="Preis" Binding="{Binding UnitPrice, Mode=TwoWay, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                                                <DataGridTextColumn Header="Kosten" Binding="{Binding LineTotal, StringFormat=N2}" IsReadOnly="True" Width="90"/>
                                                <DataGridTemplateColumn Header="" Width="86">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <StackPanel Orientation="Horizontal">
                                                                <Button Content="^" Width="22" Height="22" Padding="0" Margin="0,0,2,0"
                                                                        Style="{x:Null}"
                                                                        Command="{Binding DataContext.MoveLineUpCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Nach oben"/>
                                                                <Button Content="v" Width="22" Height="22" Padding="0" Margin="0,0,2,0"
                                                                        Style="{x:Null}"
                                                                        Command="{Binding DataContext.MoveLineDownCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Nach unten"/>
                                                                <Button Content="X" Width="22" Height="22" Padding="0"
                                                                        Style="{x:Null}"
                                                                        Foreground="Red" FontWeight="Bold"
                                                                        Command="{Binding DataContext.RemoveLineCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Position entfernen"/>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>
                                            </DataGrid.Columns>
                                        </DataGrid>
                                        <TextBlock Text="{Binding Total, StringFormat=Total: {0:N2}}" Margin="0,6,0,0" FontWeight="SemiBold" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <Grid Grid.Row="1" Margin="0,10,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Netto:" FontSize="14" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding Total, StringFormat=N2}" FontSize="14" Margin="6,0,0,0" VerticalAlignment="Center"/>
                        <TextBlock Text="CHF" FontSize="14" Margin="4,0,16,0" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding MwstLabel}" FontSize="14" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding MwstAmount, StringFormat=N2}" FontSize="14" Margin="6,0,16,0" VerticalAlignment="Center"/>
                        <TextBlock Text="Total inkl. MWST:" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding TotalInclMwst, StringFormat=N2}" FontSize="18" FontWeight="SemiBold" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        <TextBlock Text="CHF" FontSize="18" FontWeight="SemiBold" Margin="4,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>

                    <WrapPanel Grid.Column="1" HorizontalAlignment="Right">
                        <Button Content="Kosten &amp; Massnahmen uebernehmen" Width="260" Height="38" Margin="12,0,0,0"
                                Command="{Binding ApplyTotalCommand}"/>
                        <Button Content="&#x1F4C4; Kostenzusammenstellung PDF" Width="240" Height="38" Margin="8,0,0,0"
                                Command="{Binding ExportPdfCommand}"
                                CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                                ToolTip="Kostenzusammenstellung als PDF exportieren"/>
                        <Button Content="Speichern" Width="140" Height="38" Margin="8,0,0,0"
                                Command="{Binding SaveCommand}"/>
                    </WrapPanel>
                </Grid>
            </Grid>
        </GroupBox>

        <!-- Splitter center|right -->
        <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                      Background="Transparent" Cursor="SizeWE"/>

        <!-- Right panel: Katalogpositionen (Drag & Drop source) -->
        <GroupBox Grid.Column="4" Header="Katalogpositionen">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <TextBox Grid.Row="0" Margin="0,0,0,4"
                         Text="{Binding CatalogSearchText, UpdateSourceTrigger=PropertyChanged}"
                         Tag="Suche..."/>
                <ListBox x:Name="CatalogList" Grid.Row="1"
                         ItemsSource="{Binding FilteredCatalogItems}"
                         DisplayMemberPath="DisplayName"
                         PreviewMouseLeftButtonDown="CatalogList_PreviewMouseLeftButtonDown"
                         PreviewMouseMove="CatalogList_PreviewMouseMove"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="ToolTip" Value="{Binding DisplayName}"/>
                            <Setter Property="Padding" Value="4,2"/>
                            <Setter Property="Cursor" Value="Hand"/>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </Grid>
        </GroupBox>
    </Grid>
</Window>

